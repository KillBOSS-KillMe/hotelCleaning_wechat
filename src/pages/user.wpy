<template>
  <view>
    <image class="userBg" src="/img/userBg.png" />
    <view class="pageName">我的</view>
    <view class="user">
      <image src="/img/daw.jpg" />
      <view class="info">
        <view class="name">
          <text wx:if="{{userInfo.type == 1}}">{{userInfo.name}}</text>
          <text wx:if="{{userInfo.type == 2}}">{{userInfo.hotel_name}}</text>
          <view class="lv">
            <icon class="iconfont iconwuxing2 active"></icon>
            <icon class="iconfont iconwuxing2 active"></icon>
            <icon class="iconfont iconwuxing2 active"></icon>
            <icon class="iconfont iconwuxing2 active"></icon>
            <icon class="iconfont iconwuxing2"></icon>
          </view>
        </view>
        <view class="phone" wx:if="{{userInfo.type == 1}}" data-phone="{{userInfo.phone}}" @tap="runCall">电话：{{userInfo.phone}}</view>
        <view class="phone" wx:if="{{userInfo.type == 2}}" data-phone="{{userInfo.principal_phone}}" @tap="runCall">电话：{{userInfo.principal_phone}}</view>
      </view>
      <!-- status: 2    户状态：0=未认证，1=已认证，2=用户未注册，3=审核中 -->
      <view class="certification" @tap="goCertification" wx:if="{{userInfo.status == 0}}">
        <icon class="iconfont iconrenzheng"></icon>
        未认证
      </view>
      <view class="certification isCertification" wx:if="{{userInfo.status == 1}}">
        <icon class="iconfont iconrenzheng"></icon>
        已认证
      </view>
      <view class="certification" wx:if="{{userInfo.status == 2}}">
        <icon class="iconfont iconrenzheng"></icon>
        未注册
      </view>
      <view class="certification" wx:if="{{userInfo.status == 3}}">
        <icon class="iconfont iconrenzheng"></icon>
        审核中
      </view>
    </view>
    <view class="userInfo">
      <view class="month">
        <view class="item">
          <view class="name" wx:if="{{userInfo.type == 1}}">本月接单</view>
          <view class="name" wx:if="{{userInfo.type == 2}}">本月发单</view>
          <view class="num">{{userInfo.clean_data.order_receiving}}</view>
        </view>
        <view class="item">
          <view class="name">本月完成</view>
          <view class="num">{{userInfo.clean_data.to_complete_order}}</view>
        </view>
        <view class="item">
          <view class="name" wx:if="{{userInfo.type == 1}}">本月收入</view>
          <view class="name" wx:if="{{userInfo.type == 2}}">本月支出</view>
          <view class="num">{{userInfo.clean_data.to_complete_money}}</view>
        </view>
      </view>
      <view class="order">
        <view class="item">
          <view class="name">全部</view>
          <view class="num">{{userInfo.clean_data.all_status}}</view>
        </view>
        <view class="item">
          <view class="name">待确认</view>
          <view class="num">{{userInfo.clean_data.dispose_status}}</view>
        </view>
        <view class="item">
          <view class="name">待处理</view>
          <view class="num">{{userInfo.clean_data.confirmed_status}}</view>
        </view>
        <view class="item" wx:if="{{userInfo.type == 2}}">
          <view class="name">待评价</view>
          <view class="num">{{userInfo.clean_data.evaluate_status}}</view>
        </view>
        <view class="item">
          <view class="name">已完成</view>
          <view class="num">{{userInfo.clean_data.accomplish_status}}</view>
        </view>
      </view>
    </view>
    
    <view class="list">
      <!-- 酒店方 -->
      <repeat for="{{hotelFunctionList}}" item="item" wx:if="{{userInfo.type == 2}}">
        <view class="item" data-id="{{item.id}}" @tap="hotelFunction">
          <view>
            <image src="/img/{{item.img}}.png" />
            <view class="name">{{item.name}}</view>
          </view>
          <view>
            <view class="val {{item.active == '1'?'active':''}}">{{item.val}}</view>
            <icon class="iconfont iconxiayibu" wx:if="{{item.showIcon == '1'}}"></icon>
          </view>
        </view>
      </repeat>
      <!-- 保洁方 -->
      <repeat for="{{cleaningFunctionList}}" item="item" wx:if="{{userInfo.type == 1}}">
        <view class="item" data-id="{{item.id}}" @tap="cleaningFunction">
          <view>
            <image src="/img/{{item.img}}.png" />
            <view class="name">{{item.name}}</view>
          </view>
          <view>
            <view class="val {{item.active == '1'?'active':''}}">{{item.val}}</view>
            <icon class="iconfont iconxiayibu" wx:if="{{item.showIcon == '1'}}"></icon>
          </view>
        </view>
      </repeat>
    </view>
    <nav @childFn.user="goPage" @childFnOrReturn.user="goModifyUserInfo" />
  </view>
</template>

<script>
  import wepy from 'wepy'
  import nav from '../components/nav' // 底部导航
  export default class User extends wepy.page {
    config = {
      navigationBarTitleText: '我的',
      navigationStyle: "custom",
    }
    components = {
      nav: nav
    }

    mixins = []

    data = {
      userInfo: {},
      formNode: {},
      hotelFunctionList: [
        {id: '1', name: '我的钱包', img: 'wallet', val: '5600', showIcon: '1', active: '1'},
        {id: '2', name: '酒店信息', img: 'wallet', val: '', showIcon: '1', active: '0'},
        {id: '3', name: '设置', img: 'Setting', val: '', showIcon: '1', active: '0'},
        {id: '4', name: '建议与反馈', img: 'suggest', val: '029-88888888', showIcon: '0', active: '0'},
      ],
      cleaningFunctionList: [
        {id: '1', name: '我的钱包', img: 'wallet', val: '5600', showIcon: '1', active: '1'},
        {id: '2', name: '我的分享', img: 'share', val: '', showIcon: '1', active: '0'},
        {id: '3', name: '我发分享码', img: 'QRCode', val: '', showIcon: '1', active: '0'},
        {id: '4', name: '设置', img: 'Setting', val: '', showIcon: '1', active: '0'},
        {id: '5', name: '建议与反馈', img: 'suggest', val: '029-88888888', showIcon: '0', active: '0'},
      ],
    }

    computed = {}

    methods = {
      // 底部导航跳转
      goPage (url, evt) {
        // 销毁当前页{跳转}
        this.$redirect(url)
      },
      // 进入认证页
      goCertification() {
        let url = ''
        if (this.userInfo.type == 2) {
          // 执行酒店
          url = '/pages/userhotelgCertification'
        } else if (this.userInfo.type == 1) {
          // 执行保洁
          url = '/pages/userCleaningCertification'
        }
        this.$navigate(url)
      },
      // 进入酒店功能
      hotelFunction(e) {
        let id = e.currentTarget.dataset.id
        let url = ``
        switch(id) {
          case '1':
            // 我的钱包
            url += '/pages/userWallet'
            break;
          case '2':
            // 酒店信息
            url += '/pages/userReleaseList'
            break;
          case '3':
            // 设置
            url += '/pages/userHotelSetting'
            break;
          case '4':
            // 建议与反馈
            let tal = this.userInfo.service_tal
            this.$parent.runCall(tal)
            break;
          default:
            url += ''
        }
        console.log(url)
        if (url) {
          this.$navigate(url)
        }
      },
      // 进入保洁功能
      cleaningFunction(e) {
        let id = e.currentTarget.dataset.id
        let url = ``
        switch(id) {
          case '1':
            // 我的钱包
            url += '/pages/userWallet'
            break;
          case '2':
            // 我的分享
            url += '/pages/userMyShare?type=1'
            break;
          case '3':
            // 我的分享码
            url += '/pages/userMyShare?type=2'
            break;
          case '4':
            // 设置
            url += '/pages/userInfoSetting'
            break;
          case '5':
            // 建议与反馈
            console.log(this.userInfo)
            let tal = this.userInfo.service_tal
            this.$parent.runCall(tal)
            break;
          default:
            url += ''
        }
        if (url) {
          this.$navigate(url)
        }
      },
      // 拨打电话
      runCall(e){
        let phone = e.currentTarget.dataset.phone
        this.$parent.runCall(phone)
      },
    }

    events = {
      
    }

    onLoad() {
      this.userInfo = this.$parent.globalData.userInfo
      console.log(this.userInfo)
      this.$apply()
    }
    onShow() {
      // 提交用户信息
      this.setUserInfo() 
    }
    // 提交用户信息
    setUserInfo() {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/auth/my`,
        method: 'GET',
        header: {
          'content-type':'application/json',
          authorization: this.$parent.globalData.token,
          apikey: this.$parent.globalData.apikey
        },
        data: {
          status: 1
        },
        success: data => {
          data = this.$parent.null2str(data)
          if (data.data.code === 8888) {
            this.userInfo = Object.assign(this.userInfo, data.data.data);
            this.$parent.globalData.userInfo = this.userInfo
            console.log(this.userInfo)
            // 电话
            this.cleaningFunctionList[4]['val'] = this.userInfo.service_tal
            this.hotelFunctionList[3]['val'] = this.userInfo.service_tal

            // 钱包
            this.cleaningFunctionList[0]['val'] = this.userInfo.amount
            this.hotelFunctionList[0]['val'] = this.userInfo.amount
            this.$apply()
            // status: 2    户状态：0=未认证，1=已认证，2=用户未注册，3=审核中
            // type: null   用户类型1-保洁   2-酒店
            // admin_id: 0        上级用户ID
            // amount: "0.00"     余额
          } else {
            wx.showModal({
              title: '',
              content: data.data.errmsg
            })
          }
        }
      })
    }
  }

// {
//     "data": {
//         "name": "",             保洁名称
//         "phone": "",            手机号
//         "hotel_name": "测试酒店1",          酒店名称
//         "principal_phone": "18092444782",    手机号
//         "status": 0,            	用户状态：0=未认证，1=已认证，2=用户未注册，3=审核中	
//         "type": 1,              用户类型：1=保洁，2=酒店
//         "amount": "198.03",         	钱包金额
//         "service_tal": "878888",    客服电话
//         "head_portrait": "",       头像为空字符串时显示默认图片
//         "clean_data": {             保洁数据-----保洁数据-----保洁数据-----保洁数据
//             "all_status": 1,            全部
//             "confirmed_status": 0,      待处理
//             "dispose_status": 0,        待确认 
//             "accomplish_status": 1,     已完成
//             "order_receiving": 0,       本月接单
//             "to_complete_order": 1,     本月完成
//             "to_complete_money": "100.00",  本月收入
//             "level": 0          保洁星级
//         },
        // "clean_data": {              酒店数据-----酒店数据-----酒店数据-----酒店数据
        //     "all_status": 10,        全部
        //     "confirmed_status": 8,   待处理
        //     "dispose_status": 1,     待确认
        //     "evaluate_status": 0,    待评价    
        //     "accomplish_status": 0,  已完成
        //     "order_receiving": 10,   本月发单
        //     "to_complete_order": 1,  本月完成
        //     "to_complete_money": "100.00"    本月支出
        // }
//     },
</script>
<style lang="less">
.pageName{
  width: 690rpx;
  height: auto;
  padding: 30rpx;
  color: #fff;
  font-size: 30rpx;
  font-weight: 600;
  margin-top: 40rpx;
}
.userBg{
  position: absolute;
  top: 0;
  left: 0;
  width: 750rpx;
  height: 386rpx;
  z-index: -1;
}
.user{
  position: relative;
  width: 750rpx;
  height: auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  image{
    width: 108rpx;
    height: 108rpx;
    border-radius: 108rpx;
    border: 3rpx solid #fff;
    margin: 20rpx 30rpx;
  }
  .info{
    width: 350rpx;
  }
  .name{
    font-size: 35rpx;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }
  .lv{
    margin-left: 20rpx;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .active{
    color: #f0b543 !important;
  }
  icon{
    font-size: 35rpx;
    color: #D3D3D3;
    padding: 5rpx;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .phone{
    width: 240rpx;
    height: 40rpx;
    padding: 0 15rpx;
    font-size: 24rpx;
    color: #fff;
    border-radius: 60rpx;
    background-color: rgba(255, 255, 255, .7);
    border: 1rpx solid #fff;
    margin-top: 10rpx;
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }
  .certification{
    width: 164rpx;
    height: 56rpx;
    font-size: 24rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    background-color: #C8C8C8;
    border-radius: 56rpx 0 0 56rpx;
    icon{
      color: #fff;
      margin-right: 10rpx;
    }
  }
  .isCertification{
    background: linear-gradient(to left,#00A8D1,#0080DD) !important;
  }
}
.userInfo{
  box-shadow: #ebebeb 1rpx 1rpx 10rpx 5rpx;
  width: 630rpx;
  // height: 260rpx;
  height: auto;
  padding: 0 20rpx;
  border-radius: 10rpx;
  background-color: #fff;
  margin: auto;
  margin-bottom: 30rpx;
  .item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-direction: column;
  }
  .name{
    font-size: 26rpx;
    color: #898989;
  }
  .month{
    width: 630rpx;
    height: auto;
    padding: 20rpx 0;
    display: flex;
    align-items: center;
    justify-content: space-around;
    border-bottom: 2rpx dashed #D9DCEE;
    .item{
      height: 70rpx;
    }
    view{
      text-align: center;
    }
    .num{
      font-size: 24rpx;
      font-weight: 600;
      color: #f0b543;
    }
    
  }
  .order{
    width: 630rpx;
    height: auto;
    padding: 30rpx 0;
    display: flex;
    align-items: center;
    justify-content: space-around;
    view{
      text-align: center;
    }
    .num{
      font-size: 28rpx;
      font-weight: 600;
      color: #222;
    }
  }

}
.list{
  width: 690rpx;
  padding: 0 30rpx;
  height: auto;
  border-top: 20rpx solid #f3f3f3;
  padding-bottom: 150rpx;
  .item{
    width: 690rpx;
    padding: 30rpx 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1rpx solid #E9E9E9;
    color: #222;
    view{
      display: flex;
      align-items: center;
      justify-content: center;
    }
    image{
      width: 30rpx;
      height: 30rpx;
      margin-right: 20rpx;
    }
    .name{
      font-size: 28rpx;
      font-weight: 600;
    }
    .val{
      margin-right: 10rpx;
    }
    .active{
      color: #f0b543 !important;
    }
    icon{
      font-size: 25rpx;
      color: #B4B4B4;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
}
</style>