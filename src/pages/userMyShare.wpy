<template>
  <view>
    <view class="pageTitle">
      <view class="itemNav {{selShow == 1?'active':''}}" data-type="1" @tap="selNav">
        <text>邀请好友</text>
        <view></view>
      </view>
      <view class="itemNav {{selShow == 2?'active':''}}" data-type="2" @tap="selNav">
        <text>邀请好友</text>
        <view></view>
      </view>
    </view>
    <view class="pageSel" wx:if="{{selShow == 1}}">
      <view class="QRCode">
        <view class="title">邀请好友得奖励</view>
        <image src="{{QRCode}}" @tap="shareImgShow" data-imgurl="{{QRCode}}" />
      </view>
      <view class="prompt">
        <view>备注</view>
        <view>推荐用户注册后，在职一个月以后可得分享奖励</view>
      </view>
      <view class="sub">
        <view  @tap="shareImgShow" data-imgurl="{{QRCode}}">
          <icon class="iconfont iconweixin"></icon>
          分享给好友
        </view>
      </view>
    </view>
    <view class="pageSel" wx:if="{{selShow == 2}}">
      <image class="bg" src="/img/shareBg.png" />
      <view class="description">
        <view>好友累计进贡</view>
        <view>
          <icon class="iconfont iconweixin"></icon>
          什么是进贡？
        </view>
      </view>
      <view class="money">
        <view class="num">12.56</view>
        <view class="button" @tap="recharge">立即提现</view>
      </view>
      <view class="info">
        <view class="item">
          <view class="num">{{friendNode.total_money_r}}</view>
          <view class="name">今日进贡</view>
        </view>
        <view class="item">
          <view class="num">{{friendNode.total}}</view>
          <view class="name">我的好友</view>
        </view>
        <view class="item">
          <view class="num">{{friendNode.total_money}}</view>
          <view class="name">累计进贡</view>
        </view>
      </view>
      <view class="title">我的好友</view>
      <view class="userList">
        <repeat for="{{friendList}}" item="item">
          <view class="item">
            <image src="/img/daw.jpg" wx:if="{{item.image_url == ''}}"/>
            <image src="{{item.image_url}}" wx:if="{{item.image_url != ''}}"/>
            <view class="userInfo">
              <view class="name">{{item.name}}</view>
              <view class="active" wx:if="{{item.status == '0'}}">未认证</view>
              <view class="active" wx:if="{{item.status == '1'}}">已认证</view>
              <view class="active" wx:if="{{item.status == '2'}}">未注册</view>
              <view class="active" wx:if="{{item.status == '3'}}">审核中</view>
              <view wx:if="{{item.money != ''}}">
              <!-- <view> -->
                累计进贡：
                <text>￥{{item.money}}</text>
              </view>
            </view>
            <view class="time">绑定时间：{{item.updated_at}}</view>
          </view>
        </repeat>
        <view class="listMore" @tap="getFriendList" wx:if="{{current_page < last_page}}">
          <text>加载更多</text>
          <icon class="iconfont iconxiala"></icon>
        </view>
        <!-- <view class="item">
          <image src="/img/shareBg.png" />
          <view class="userInfo">
            <view class="name">二狗子</view>
            <view class="active">待注册</view>
            <view>
              累计进贡：
              <text>￥12.56</text>
            </view>
          </view>
          <view class="time">绑定时间：2019.12.21</view>
        </view> -->
        <view class="listNull" wx:if="{{friendList.length == 0}}">暂无数据</view>
      </view>
    </view>
      
  </view>
</template>

<script>
  import wepy from 'wepy'
  export default class UserMyShare extends wepy.page {
    config = {
      navigationBarTitleText: '我的分享码'
    }
    components = {}

    mixins = []

    data = {
      selShow: '',
      QRCode: '',
      friendNode: {},
      friendList: [],
      current_page: 0,
      last_page: 0,
    }

    computed = {}

    methods = {
      selNav(e) {
        this.selShow = e.currentTarget.dataset.type
        this.$apply()
        if (this.selShow == '2') {
          this.getFriendList()
        }
      },
      recharge(e) {
        // 进入充值页
        let url = `/pages/userRecharge`
        this.$navigate(url)
      },
      shareImgShow(e) {
        let url =  e.currentTarget.dataset.imgurl
        wx.previewImage({
          current: [url], // 当前显示图片的http链接   
          urls: [url] // 需要预览的图片http链接列表   
        })
      },
    }

    events = {
      
    }

    onLoad(options) {
      this.selShow = options.type
      this.userInfo = this.$parent.globalData.userInfo
      this.$apply()
      this.getQRCode()
      if (options.type == 1) {
        // 加载二维码
        // this.getQRCode()
      } else {
        // 加载好友列表及进贡信息
        this.getFriendList()
      }
    }
    // 获取二维码
    getQRCode() {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/wx/get_small_program_code`,
        method: 'GET',
        header: {
          'content-type':'application/json',
          authorization: this.$parent.globalData.token,
          apikey: this.$parent.globalData.apikey
        },
        success: data => {
          data = this.$parent.null2str(data)
          if (data.data.code === 8888) {
            this.QRCode = data.data.url
            this.$apply()
          } else {
            wx.showModal({
              title: '',
              content: data.data.msg
            })
          }
        }
      })
    }
    // 好友列表获取
    getFriendList() {
      // if (this.friendList.length > 0) {
      //   return false
      // }
      wx.showToast({
        title: "拼命加载中...",
        icon: 'loading',
        duration: 1000000
      });
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/auth/clean_user_friend_list`,
        header: {
          authorization: this.$parent.globalData.token,
          apikey: this.$parent.globalData.apikey
        },
        data: {
          page: this.current_page + 1
        },
        method: 'GET',
        success: data => {
          wx.hideToast()
          data = this.$parent.null2str(data)
          console.log(data)
          if (data.data.code === 8888) {
            this.friendNode = data.data.data
            this.friendList = this.friendList.concat(data.data.data.data)
            // 当前页码
            this.current_page = data.data.data.current_page
            // 总页码
            this.last_page = data.data.data.last_page

            // "last_page": 1,     表示总页数
            // "per_page": 10,      表示每页条数
            // "current_page": 1,   表示当前页
            // "total": 1           表示总条数
            this.$apply()
          }
        }
      })
    }
  }
</script>
<style lang="less">
.pageTitle{
  display: flex;
  align-items: center;
  justify-content: space-around;
  .itemNav{
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-direction: column;
    color: #898989;
    text{
      font-size: 32rpx;
    }
    view{
      margin-top: 10rpx;
      width: 59rpx;
      height: 6rpx;
      background-color: #fff;
    }
  }
  .active{
    color: #222;
    font-weight: 600;
    view{
      background: linear-gradient(to left,#30A2F4,#00E8BD);
    }
  }
}
.pageSel{
  width: 750rpx;
  height: auto;
  position: relative;
}
.QRCode{
  margin-top: 200rpx;
  width: 750rpx;
  height: 600rpx;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-direction: column;
  .title{
    text-align: center;
    font-size: 34rpx;
    font-weight: 600;
    color: #222;
  }
  image{
    width: 560rpx;
    height: 560rpx;
    border: 5rpx solid #30A2F4;
    margin-top: 20rpx;
  }
}
.prompt{
  width: 690rpx;
  padding: 30rpx;
  font-size: 28rpx;
  color: #898989;
}
.bg{
  width: 750rpx;
  height: 304rpx;
  position: absolute;
  left: 0;
  top: 0;
  z-index: -1;
}
.description{
  margin-top: 20rpx;
  width: 690rpx;
  padding: 30rpx;
  font-size: 28rpx;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  view{
    display: flex;
    align-items: center;
  }
  icon{
    font-size: 28rpx;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10rpx;
  }
}
.money{
  width: 690rpx;
  padding: 0 30rpx;
  display: flex;
  align-items: center;
  justify-content: space-between;
  .num{
    font-size: 50rpx;
    font-weight: 600;
    color: #fff;
  }
  .button{
    background-color: #fff;
    color: #222;
    padding: 10rpx 20rpx;
    font-size: 26rpx;
    font-weight: 600;
    border-radius: 50rpx;
  }
}
.info{
  display: flex;
  align-items: center;
  justify-content: space-around;
  margin: auto;
  margin-top: 30rpx;
  width: 690rpx;
  height: 180rpx;
  border-radius: 10rpx;
  background-color: #fff;
  box-shadow: #ebebeb 1rpx 1rpx 10rpx 5rpx;
  .item{
    display: flex;
    align-items: center;
    justify-content: space-around;
    flex-direction: column;
  }
  .num{
    font-size: 26rpx;
    font-weight: 600;
    color: #FE892F;
    margin-bottom: 20rpx;
  }
  .name{
    font-size: 28rpx;
    font-weight: 600;
    color: #222;
  }
}
.title{
  width: 690rpx;
  height: auto;
  padding: 30rpx;
  font-size: 32rpx;
  font-weight: 600;
  color: #222;
}
.userList{
  .item{
    width: 650rpx;
    height: 115rpx;
    padding: 30rpx 20rpx;
    background-color: #fff;
    box-shadow: #ebebeb 1rpx 1rpx 10rpx 5rpx;
    border-radius: 10rpx;
    display: flex;
    // align-items: center;
    justify-content: flex-start;
    margin: auto;
    margin-bottom: 30rpx;
    image{
      width: 116rpx;
      height: 116rpx;
      border-radius: 115rpx;
    }
    .userInfo{
      width: 252rpx;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      flex-direction: column;
      font-size: 26rpx;
      color: #222;
      text{
        font-weight: 600;
        color: #FE892F;
      }
    }
    .name{
      width: 100%;
      font-size: 32rpx;
      font-weight: 600;
      color: #222;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .time{
      font-size: 24rpx;
      color: #898989;
    }
    .active{
      color: #FE892F;
    }
  }
}

</style>